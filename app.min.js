(function(jQuery) {
  var checkGA = function() {
    var GA_TRACKING_ID = 'UA-85802533-1';
    var GA_DISABLE = 'ga-disable-' + GA_TRACKING_ID;

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', GA_TRACKING_ID);

    document.dariahDisableGtm = function() {
      document.cookie = GA_DISABLE + '=true; expires=Thu, 31 Dec 2099 23:59:59 UTC; path=/';
      window[ GA_DISABLE ] = true;
      alert('Thanks. We have set a cookie so that Google Analytics data collection will be disabled on your next visit.');
    };

    if (document.cookie.indexOf( GA_DISABLE + '=true' ) > -1) {
      window[ GA_DISABLE ] = true;
    } else {
      var ga = document.createElement('script');
      ga.type = 'text/javascript';
      ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://www' : 'http://www') + '.googletagmanager.com/gtag/js?id=' + GA_TRACKING_ID;

      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(ga, s);
    }
  };

  var onMailChimpSignup = function(event) {
    event.preventDefault();
    event.stopPropagation();

    jQuery('#mc_message').empty();
    jQuery('#mc_signup_form :input').prop('disabled', true);
    var data = {
      firstname: jQuery('#mc_mv_FNAME').val(),
      lastname: jQuery('#mc_mv_LNAME').val(),
      email: jQuery('#mc_mv_EMAIL').val(),
      institution: jQuery('#mc_mv_INSTITUTION').val()
    };
    jQuery.post(jQuery(this).attr('action'), data)
      .done(function(data) {
        jQuery('#mc_signup_form :input').prop('disabled', false);
        if (data.code < 400) {
          jQuery('#mc_signup_form :input[type=text]').val('');
        }
        jQuery('#mc_message').html('<span class="' + data.state + '">' + data.message + '</span>');
      })
      .fail(function(err) {
        jQuery('#mc_signup_form :input').prop('disabled', false);
        jQuery('#mc_message').html('<span class="error">Some problem occurred, please try again</span>');
      });
  };

  var onSeeMoreClick = function(event) {
    event.preventDefault();
    event.stopPropagation();
    jQuery('.person-desc').removeClass('full');

    jQuery(this).closest('.person-desc').addClass('full');
  };
  var onSeeLessClick = function(event) {
      event.preventDefault();
      event.stopPropagation();
      jQuery(this).closest('.person-desc').removeClass('full');
  };

  jQuery(window).ready(function() {
    checkGA();
    var classNames = [];
    if (navigator.userAgent.match(/(iPad|iPhone|iPod)/i)) classNames.push('device-ios');
    if (navigator.userAgent.match(/android/i)) classNames.push('device-android');

    var html = document.getElementsByTagName('html')[0];

    if (classNames.length) classNames.push('on-device');
    if (html.classList) html.classList.add.apply(html.classList, classNames);
    
    jQuery('.person-desc .see-more').on('click', onSeeMoreClick);
    jQuery('.person-desc .see-less').on('click', onSeeLessClick);
    jQuery('#mc_signup_form').on('submit', onMailChimpSignup);
  });
})(jQuery);

(function(jQuery) {
  var contentBerlin = '<p class="title">DARIAH-EU Coordination Office</p>Centre Marc Bloch<br />Friedrichstra√üe' +
      ' 191<br />D-10117 Berlin<br />Germany';
  var contentTheHague = '<p class="title">DANS : Netherland Institute for Permanent Access to Digital Research' +
      ' Ressources</p>Anna van Saksenlaan 51<br/>2593 HW The Hague<br/>P.O. Box 93067<br/>2509 AB The' +
      ' Hague<br/>Netherlands';
  var contentParis = '<p class="title">DARIAH-EU</p>c/o TGIR Huma-Num<br/>TGIR HUMA-NUM<br/>CNRS UMS 3598<br/>54 bd' +
      ' Raspail<br/>75006 Paris<br/>France';
  var contentDublin = '<p class="title">Trinity College Dublin</p>Trinity Long Room Hub Arts and Humanities Research' +
      ' Institute<br/>The University of Dublin<br/>College Green<br/>Dublin 2<br/>Ireland';
  var positionBerlin = {
    lat: 52.5107910,
    lng: 13.3896580
  };
  var positionTheHague = {
    lat: 52.0808688,
    lng: 4.3449038
  };
  var positionParis = {
    lat: 48.850221,
    lng: 2.3267449
  };
  var positionDublin = {
    lat: 53.3436974,
    lng: -6.2566108
  };
  var dco = [];
  dco.push([contentBerlin, positionBerlin]);
  dco.push([contentTheHague, positionTheHague]);
  dco.push([contentParis, positionParis]);
  dco.push([contentDublin, positionDublin]);

  var imagesPath = '/wp-content/themes/thefox-child/images/';
  var map;

  var handleClick = function(event) {
    event.target.openPopup();
  };

  var initMap = function() {
    map = L.map('contactMap', {
      scrollWheelZoom: false,
      minZoom: 4,
      maxZoom: 18
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png').addTo(map);
    var marker;
    var array = [];
    for (var i = 0; i < dco.length; i++) {
      var item = dco[i];
      var iconCountry = L.icon({ iconUrl: imagesPath + 'contact-marker.png', iconSize: [20, 20], iconAnchor: [10, 10], popupAnchor: [1, -20] });
      marker = new L.marker([item[1].lat,item[1].lng], {
        icon: iconCountry
      }).bindPopup(item[0]).on('click', handleClick);
      array.push(marker);
    }

    var group = L.featureGroup(array).addTo(map);
    map.fitBounds(group.getBounds());
  };

  jQuery(window).ready(function() {
    if (jQuery('#contactMap').length !== 0) {
      initMap();
    }
  });
})(jQuery);

(function(jQuery) {
  equalheight = function(container){
    var currentTallest = 0;
    var currentRowStart = 0;
    var rowDivs = [];
    var jQueryel;
    var topPosition = 0;

    jQuery(container).each(function() {
      jQueryel = jQuery(this);
      jQuery(jQueryel).height('auto');
      topPostion = jQueryel.position().top;

      if (currentRowStart != topPostion) {
        for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
          rowDivs[currentDiv].height(currentTallest);
        }
        rowDivs.length = 0; // empty the array
        currentRowStart = topPostion;
        currentTallest = jQueryel.height();
        rowDivs.push(jQueryel);
      } else {
        rowDivs.push(jQueryel);
        currentTallest = (currentTallest < jQueryel.height()) ? (jQueryel.height()) : (currentTallest);
      }
      for (currentDiv = 0 ; currentDiv < rowDivs.length ; currentDiv++) {
        rowDivs[currentDiv].height(currentTallest);
      }
    });
  };

  jQuery(window).ready(function() {
    onResize();
    jQuery('.tnp-email').attr('placeholder', 'E-mail');

    printIncrement();
  });

  function onResize() {
    equalheight('.menu-home-container .description');
    equalheight('.menu-home-double-menu-container .description');
    if (jQuery("#menu-home-triple-menu li").css("display") === "inline-block" ) {
      equalheight('.menu-home-triple-menu-container .widgetizedArea');
    } else {
      jQuery('.menu-home-triple-menu-container .widgetizedArea').each(function() {
        jQuery(this).height('auto');
      });
    }
    equalheight('.menu-home-quadruple-menu-container .description');
    equalheight('.app-category .app-content');
    equalheight('.item-list li');
  }

  jQuery(window).resize(onResize);

  jQuery(window).scroll(function(){
    printIncrement();
  });

  function printIncrement() {
    var numbersSection = document.getElementById("numbers-section");
    if (!isElementOutViewport(numbersSection) && jQuery("#numbers-section").attr("data-start") === "false") {
      increment(jQuery("#increment-countries"));
      increment(jQuery("#increment-institutions"));
      increment(jQuery("#increment-partners"));
      jQuery("#numbers-section").attr("data-start","true");
    }
  }

  function increment(elementToIncrement) {
    var element = jQuery(elementToIncrement);
    var number = element.attr("data-top");
    number = parseInt(number,10);
    var i=0;
    function incrementItem() {
      i++;
      element.html(i);
      if (i===number) {
        clearInterval(interval);
      }
    }
    var incrementTime = 1000/number;
    var interval = setInterval(incrementItem, incrementTime);
  }

  function isElementOutViewport(el){
    var rect = el.getBoundingClientRect();
    return rect.bottom < 0 || rect.right < 0 || rect.left > window.innerWidth || rect.top > window.innerHeight;
  }
})(jQuery);

(function(jQuery) {
  var COUNTRY_TYPE = 'country';
  var PROJECT_TYPE = 'project';
  var geoCountries;
  var map;
  var selectedObject;
  var layerMarker;
  var institutionsMarker = [];
  var countryMarker;
  var dariahMapData;
  var popup;
  var themePath = '/wp-content/themes/thefox-child/';

  var projectIcon;
  var countryIcon;

  var createMarkers = function() {
    dariahMapData.institutions
      .map(function(institution) {
        if (institution.latitude === '' || institution.longitude === '') {
          return;
        }
        institutionsMarker.push(
          L.marker([institution.latitude, institution.longitude], {
            icon: projectIcon,
            institution: institution
          }).on('click', onMarkerClick)
        );
      });
    layerMarker = L.layerGroup(institutionsMarker).addTo(map);

    setTimeout(function() {
      jQuery('#mapContainer .loader').fadeOut('300', function() {
         jQuery('#mapContainer').removeClass('loading');
      });
    }, 500);
  };

  var onMarkerClick = function(event) {
    var institution = event.target.options.institution;
    var projects = institution.coordinators || institution.projects;
    if (selectedObject && institution.coordinators && institution.projects) {
      projects = institution.coordinators.concat(institution.projects);
    }
    if (projects.length > 1) {
      displayInstitutionInformation(institution, projects, event.target);
    } else {
      window.alert('No Project for ' + institution.name);
    }
  };

  var initMap = function() {
    map = L.map('dariahMap', {
      scrollWheelZoom: false,
      minZoom: 3,
      maxZoom: 16
    });
    map.scrollWheelZoom.disable();
    var viewCenter = {
      lat: window.innerWidth < 768 ? 55 : 50,
      lng: window.innerWidth < 768 ? 4 : -18
    };
    map.setView(viewCenter, window.innerWidth <=768 ? 3 : 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png').addTo(map);

    geoCountries = L.geoJson(euCountries, { onEachFeature: onEachFeature}).addTo(map);
    createMarkers();

    var legend = L.control();
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'info legend'),
            colors = ["Member Countries", "Cooperating Partners"],
            labels = ["members", "cooperating-partners"];

        // loop through our density intervals and generate a label with a colored square for each interval
        for (var i = 0; i < colors.length; i++) {
            div.innerHTML += '<i class="' + labels[i] + '"></i> ' + colors[i] + '<br>';
        }
        return div;
    };
    legend.addTo(map);
  };

  var initWindow = function() {
    jQuery('#dariahWindow ul a').on('click', onTabClick);

    jQuery('#dariahWindow .close').on('click', function(event) {
      var scr = jQuery(window).scrollTop();
      event.preventDefault();
      event.stopPropagation();

      mapEnable();
      selectType();
      jQuery('#dariahIntro').show();
      window.location.hash = "";
      jQuery(window).scrollTop(scr);
    });

    selectType();

    if(window.location.hash) {
        onCountryAnchor(window.location.hash.substring(1).toUpperCase());
    }
  };

  function onTabClick(event) {
    event.preventDefault();
    event.stopPropagation();
    selectTab(jQuery(event.target).data('tab-id'));
  }

  function onEachFeature(feature, layer) {
    layer.on('add', onCountryAdded);
    layer.on('click', onCountryClick);
  }

  function onCountryAdded(event) {
    var layer = event.target;
    var iso3 = layer.feature.properties.ISO3;
    var country = dariahMapData.countries[iso3];
    if (country) {
      jQuery(layer._path).addClass(country.status);
    }
  }

  function onCountryClick(event) {
    var layer = event.target;
    var iso3 = layer.feature.properties.ISO3;
    var country = dariahMapData.countries[iso3];
    if (country) {
      displayCountryInformation(country);
      deleteCountryMarker();
      countryMarker = L.marker([country.capital.latitude, country.capital.longitude], {icon: countryIcon}).addTo(map);
      selectCountry([iso3]);
      window.location.hash = "#" + iso3.toLowerCase();
    }
  }

  function onCountryAnchor(iso3) {
    var country = dariahMapData.countries[iso3];
    displayCountryInformation(country);
    deleteCountryMarker();
    countryMarker = L.marker([country.capital.latitude, country.capital.longitude], {icon: countryIcon}).addTo(map);
    selectCountry([iso3]);
  }

  function centerTo(latlng) {
    var center = map.project(latlng);
    var deltaLat = window.innerWidth < 768 ? 0 : -300;
    var deltaLng = 0;
    center = new L.point(center.x + deltaLat, center.y + deltaLng);
    target = map.unproject(center);
    map.panTo(target);
  }

  function displayInstitutionInformation(institution, projectIDs, marker) {
    // jQuery('#dariahWindow').hide();
    mapDisable();
    jQuery('body').removeClass('fixed');
    var _currentCountry = '';
    for (var countryISO3 in dariahMapData.countries) {
      var country = dariahMapData.countries[countryISO3];
      if (country.id === parseInt(institution.country, 10)) {
        _currentCountry = country.name;
      }
    }
    var html = '<p>' + _currentCountry + '</p>';
    html += '<ul>';
    html +=  dariahMapData.projects
      .filter(function(project) { return projectIDs.indexOf(project.id) !== -1; })
      .map(function(project) { return '<li><a href="#" data-project-id="' + project.id + '" data-institution-id="' + institution.id + '">' + project.name + '</a></li>';})
      .join('');
    html += '</ul>';
    marker.unbindPopup();
    marker.bindPopup(html).openPopup();
  }

  function deleteCountryMarker() {
    if (countryMarker) {
      countryMarker.remove();
    }
  }

  function displayCountryInformation(country) {
    if (!country) {
      jQuery('#dariahWindow').hide();
      jQuery('body').removeClass('fixed');
      return;
    }
    mapDisable();

    showInformationWindow();
    var dariahWindow = jQuery('#dariahWindow');
    selectedCountry = country;
    jQuery(dariahWindow).removeClass();
    jQuery(dariahWindow).addClass(COUNTRY_TYPE);

    jQuery(dariahWindow).find('h1').html(selectedCountry.name + '<span>' + selectedCountry.statusName + '</span>');
    jQuery(dariahWindow).find('li:nth-child(1) a').html('National<br />Coordination');
    jQuery(dariahWindow).find('li:nth-child(2) a').html('Partner<br />Institutions');
    jQuery(dariahWindow).find('li:nth-child(3) a').html('Cooperating<br />Partners');
    jQuery(dariahWindow).find('li:nth-child(4) a').html('DARIAH<br/>nationally');

    var _selectedTab;
    if (selectedCountry.entities.length === 0 && selectedCountry.national.persons.length === 0 && selectedCountry.national.institutions === 0 && selectedCountry.nationalInstitutions.length === 0 && selectedCountry.coordinators.length === 0) {
      jQuery(dariahWindow).find('li:nth-child(1)').hide();
    } else {
      jQuery(dariahWindow).find('li:nth-child(1)').show();
      _selectedTab = 1;
    }

    if (selectedCountry.partnerInstitutions.length === 0) { jQuery(dariahWindow).find('li:nth-child(2)').hide(); }
    else { jQuery(dariahWindow).find('li:nth-child(2)').show(); _selectedTab = _selectedTab ? _selectedTab : 2; }

    if (selectedCountry.cooperatingInstitutions.length === 0) { jQuery(dariahWindow).find('li:nth-child(3)').hide(); }
    else { jQuery(dariahWindow).find('li:nth-child(3)').show(); _selectedTab = _selectedTab ? _selectedTab : 3; }

    if (selectedCountry.countryDescription.length === 0) { jQuery(dariahWindow).find('li:nth-child(4)').hide(); }
    else { jQuery(dariahWindow).find('li:nth-child(4)').show(); _selectedTab = _selectedTab ? _selectedTab : 4; }
    // jQuery(dariahWindow).find('li:nth-child(4)').hide();

    selectTab(_selectedTab);
  }

  function selectCountry(countries) {
    geoCountries.eachLayer(function (layer) {
      if (countries && countries.indexOf(layer.feature.properties.ISO3) !== -1) {
        var center = map.project(layer.getBounds().getCenter());
        if (window.innerWidth > 767) {
         center = new L.point(center.x-250,center.y+0);
        }
         var target = map.unproject(center);
         map.panTo(target);
        jQuery(layer._path).addClass('selected');
      } else {
        jQuery(layer._path).removeClass('selected');
      }
    });
  }

  function selectTab(id) {
    jQuery('#dariahWindow .content').scrollTop(0);
    jQuery('#dariahWindow li').each(function() {
      jQuery(this).removeClass();
      if (jQuery(this).find('a').data('tab-id') == id) {
        jQuery(this).addClass('selected');
      }
    });

    jQuery('#dariahWindow .content').html( contentCountryTab(id) );
    jQuery('#dariahWindow .content a').on('click', onContentLink);
  }

  function onContentLink(event) {
    event.preventDefault();
    event.stopPropagation();
    if (jQuery(event.target).data('institution-id')) {

    } else {
      window.open(jQuery(event.target).attr("href"), '_blank');
    }
  }

  function contentCountryTab(id) {
    var html= '';
    switch (id) {
      case 1:
        var logo = "";
        if(selectedCountry.countryLogo != null) {
          logo = '<img width="100" height="20" style="margin-right: 30px;" src="' + selectedCountry.countryLogo + '" alt="Logo"/>';
          html += logo;
        }
        if(selectedCountry.website != null && selectedCountry.websitename != null) {
          html += '<a href="' + selectedCountry.website + '">' + selectedCountry.websitename + '</a>';
        }

        if (selectedCountry.entities.length !== 0) {
          if(selectedCountry.entities.length > 1) {
            html += '<p class="point">Representing Entities:';
          } else {
            html += '<p class="point">Representing Entity:';
          }
          html += selectedCountry.entities.map(function(entity) { return '<span>' + entity.name.replace("--", ", ") + '</span>'; }).join('');
          html += '</p>';
        }
        if (selectedCountry.national.persons.length > 0 || selectedCountry.national.institutions.length > 0) {
          if(selectedCountry.national.persons.length > 1) {
            html += '<p class="point">National Representatives:';
          } else {
            html += '<p class="point">National Representative:';
          }
          if (selectedCountry.national.persons.length > 0) {
            html += selectedCountry.national.persons.map(function(personID) {
              var person = dariahMapData.persons[parseInt(personID, 10)];
              return '<span>' + person.firstname + ' ' + person.lastname + '</span>';
            }).join('');
          }
          if (selectedCountry.national.institutions.length > 0) {
            html += selectedCountry.national.institutions.map(function(institutionID) {
              var institution = dariahMapData.institutions.filter(function(institution) { return institution.id === parseInt(institutionID, 10); });
              var htmlInstitution = '<span class="ico-marker">' + institution[0].name + '</span>';
              return htmlInstitution;
            }).join('');
          }
          html += '</p>';
        }
        var nationalCoordinating = dariahMapData.institutions
          .filter(function(institution) { return selectedCountry.nationalInstitutions.indexOf(institution.id) !== -1; })
          .sort(sortByName);
        if (nationalCoordinating.length !== 0) {
          if(nationalCoordinating.length > 1) {
            html += '<p class="point">National Coordinating Institutions:';
          } else {
            html += '<p class="point">National Coordinating Institution:';
          }
          html += nationalCoordinating.map(function(institution) {
            var htmlInstitution = institution.website ? '<a href="' + institution.website + '" class="ico-marker">' + institution.name + '</a>' : '<span class="ico-marker">' + institution.name + '</span>';
            return htmlInstitution;
          }).join('');
          html += '</p>';
        }

        if (selectedCountry.coordinators.length !== 0) {
          if(selectedCountry.coordinators.length > 1) {
            html += '<p class="point">National Coordinators:';
          } else {
            html += '<p class="point">National Coordinator:';
          }
          html += selectedCountry.coordinators.map(function(entity) {
            var person = dariahMapData.persons[parseInt(entity, 10)];
            if (person) {
              if (person.link !== '') {
                return '<a href="' + person.link + '" class="ico-person">' + person.firstname + ' ' + person.lastname + '</a>';
              } else {
                return '<span class="ico-person">' + person.firstname + ' ' + person.lastname + '</span>';
              }
            }
          }).join('');
          html += '</p>';
        }
        selectInstitutionMarker([]);
        break;
      case 2:
        var _institutions = dariahMapData.institutions
          .filter(function(institution) { return selectedCountry.partnerInstitutions.indexOf(institution.id) !== -1; })
          .sort(sortByName);
        html += '<h2>Partner Institutions:</h2>';
        html += '<ul class="list">';
        html += _institutions.map(function(institution) {
           var li = institution.website ? '<a href="' + institution.website + '">' + institution.name + '</a>' : institution.name;
            return '<li>' + li + '</li>';
          }).join('');
        html += '</ul>';
        selectInstitutionMarker(_institutions.map(function(institution) { return institution.id; }));
        break;
      case 3:
        var _cooperatingInstitutions = dariahMapData.institutions
          .filter(function(institution) { return selectedCountry.cooperatingInstitutions.indexOf(institution.id) !== -1; })
          .sort(sortByName);
        html += '<h2>Cooperating partners:</h2>';
        html += '<ul class="list">';
        html += _cooperatingInstitutions.map(function(institution) {
              var li = institution.website ? '<a href="' + institution.website + '">' + institution.name + '</a>' : institution.name;
              return '<li>' + li + '</li>';
          }).join('');
        html += '</ul>';
        selectInstitutionMarker([]);
        break;
      case 4:
        html += selectedCountry.countryDescription;
        selectInstitutionMarker([]);
        break;
    }

    return html;
  }

  function selectInstitutionMarker(institutionIDs) {
    institutionsMarker.map(function (marker) {
      if (!institutionIDs) {
        if (marker.options.institution.coordinators) {
          layerMarker.addLayer(marker);
        } else if (layerMarker.hasLayer(marker)) {
          layerMarker.removeLayer(marker);
        }
      } else if (institutionIDs.indexOf(marker.options.institution.id) !== -1) {
        layerMarker.addLayer(marker);
      } else if (layerMarker.hasLayer(marker)) {
        layerMarker.removeLayer(marker);
      }
    });
  }

  function selectType() {
    selectedObject = null;
    selectCountry([]);
    deleteCountryMarker();

    jQuery('#dariahWindow').hide();
    jQuery('body').removeClass('fixed');
    map.removeLayer(layerMarker);
    selectInstitutionMarker([]);
  }

  function showInformationWindow() {
    jQuery('#dariahWindow').show();
    if (window.innerWidth < 768) {
      jQuery('html,body').animate({scrollTop: jQuery('#mapContainer').offset().top - jQuery('.mt_menu').height() - 10},'slow');
    }
    jQuery('body').addClass('fixed');
    jQuery('#dariahIntro').hide();
    map.closePopup();
  }

  function mapDisable() {
    map._handlers.forEach(function(handler) {
      handler.disable();
    });
  }

  function mapEnable() {
    map._handlers.forEach(function(handler) {
      handler.enable();
    });
    map.scrollWheelZoom.disable();
  }

  function sortByName(a, b) {
    var aName = a.name.toLowerCase();
    var bName = b.name.toLowerCase();
    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
  }

  jQuery(window).ready(function() {
    if (jQuery('#dariahMap').length !== 0) {
      projectIcon = L.icon({ iconUrl: themePath + 'images/map-leaflet-marker-project-small.png', iconSize: [22, 28], iconAnchor: [11, 24], popupAnchor: [1, -20] });
      countryIcon = L.icon({ iconUrl: themePath + 'images/map-leaflet-marker-country.png', iconSize: [37, 47], iconAnchor: [18, 41], popupAnchor: [-3, -76] });

      jQuery.getJSON(themePath + 'map/dynamic-data.json', function(data) {
        dariahMapData= data;
        initMap();
        initWindow();
      });
    }
  });
})(jQuery);

(function(jQuery) {
  var selectedArea;

  var onBackToList = function(event) {
    event.preventDefault();
    event.stopPropagation();
    backToList();
  };

  var backToList = function() {
    jQuery('#positions .contact-list').show();
    jQuery('#positions .contact-complete').hide();
    jQuery('#positions .contact-complete').empty();
  };

  var onSeeMore = function(event) {
    event.preventDefault();
    event.stopPropagation();

    jQuery('#positions .contact-complete').empty();

    var person = selectedArea.persons[jQuery(event.target).data('id')];
    if (person) {
      var _html = '';
      _html += '<div class="' + person.imageClasses + '" style="background-image: url(' + person.image + ');"></div>';
      _html += '<div class="content">';
      _html += '<h2>' + person.firstname + ' ' + person.lastname + '</h2>';
      if (person.position) { _html += '<p class="position">' + person.position + '</p>'; }
      _html += '<p class="description-full">' + person.full + '</p>';
      if (person.skills) { _html += '<p class="skills"><span class="title">Skills and research fields:</span>' + person.skills + '</p>'; }
      if (person.link) { _html += '<a href="' + person.link + '" target="_blank" class="link about">About</a>'; }
      if (person.email) { _html += '<a href="mailto:' + person.email + '" class="dariah-mail">Email</a>'; }
      _html += "</div>";
      _html += '<a href="#" class="back">< BACK TO LIST</a>';
      jQuery('#positions .contact-complete').append(_html);
      jQuery('#positions .back').on('click', onBackToList);
      jQuery('#positions .contact-list').hide();
      jQuery('#positions .contact-complete').show();
      jQuery('html,body').animate({scrollTop: jQuery('#contactComplete').offset().top - jQuery('.mt_menu').height() - 10},'slow');
    }
  };

  var onCloseClick = function(event) {
    event.preventDefault();
    event.stopPropagation();
    jQuery('#positions').hide();
    jQuery('#positions .contact-list').empty().show();
    jQuery('#positions .contact-complete').empty().hide();
  };

  var onPathClick = function(event) {
    moveIntoPosition(event.currentTarget.id);
  };

  function moveIntoPosition(positionIdentifier) {
    var position = false;
    if(typeof dariahPositionsData !== 'undefined') {
        position = dariahPositionsData[positionIdentifier];
    }
    if (!position) {
      jQuery('#positions').hide();
      selectedArea = null;
      return;
    }

    selectedArea = position;

    jQuery('#positions h2').text(position.name);
    jQuery('#positions .description').html(position.description);
    jQuery('#positions .contact-list').empty();

    if (positionIdentifier !== 'working-groups') {
      for (var personKey = 0; personKey < position.persons.length; personKey++) {
        var person = position.persons[personKey];

        var _html = '<li><div class="person-desc">';
        _html += '<div class="' + person.imageClasses + '" style="background-image: url(' + person.image + ');"></div>';
        _html += '<div class="content">';
        _html += '<p class="name">' + person.firstname + ' ' + person.lastname + '</p>';

        if (person.position) { _html += '<p class="position">' + person.position + '</p>'; }
        _html += '<p class="description-excerpt">' + person.excerpt + '</p>';
        if (person.displayMore) { _html += '<a href="#" class="link see-more" data-id="' + personKey + '">See more</a>'; }
        if (person.email) { _html += '<a href="mailto:' + person.email + '" class="dariah-mail">Email</a>'; }
        _html += "</div></div></li>";

        jQuery('#positions .contact-list').append(_html);
      }
    }
    backToList();
    window.location.hash = "#" + positionIdentifier;

    jQuery('#positions .see-more').on('click', onSeeMore);
    jQuery('#positions').show();
    jQuery("html, body").animate({ scrollTop: jQuery('#positions').offset().top - 50 }, 1000);
  }


  jQuery(window).ready(function() {
    jQuery('svg #blocs g').on('click', onPathClick);
    jQuery('#positions .close').on('click', onCloseClick);
    if(window.location.hash) {
      moveIntoPosition(window.location.hash.substring(1).toLowerCase());
    }

  });
})(jQuery);

(function(jQuery) {
  var currentPage = 0;
  var itemPerPage = 10;
  var defaultFilterToShow = 5;
  var dariahYearbookData;
  var totalPages;
  var results = [];
  var sortAZ = true;
  var themePath = '/wp-content/themes/thefox-child/';

  function sortObject(data) {
    var valueOrder;
    if (typeof Object.keys === 'function') {
      valueOrder = Object.keys(data);
    } else {
      for (var key in data) {
        valueOrder.push(key);
      }
    }
    return valueOrder.sort(function(a, b){
      if (typeof data[a] === 'object') {
        return data[a].name.localeCompare(data[b].name);
      }
      return data[a].localeCompare(data[b]);
    });
  }

  var _initFilters = function() {
      var positions = '<section>';
      positions += '<h4>DARIAH bodies</h4>';
      positions += '<ul>';
      var sortedPositions = sortObject(dariahYearbookData.positions);
      for (var sortedPositionId in sortedPositions) {
          var positionId = sortedPositions[sortedPositionId];
          var position = dariahYearbookData.positions[positionId];
          elementId = 'position' + positionId;
          positions += '<li><input id="' + elementId + '" name="positions" type="checkbox" value="' + positionId + '"/><label for="' + elementId + '">' + position + '</label></li>';
      }
      positions += '</ul>';
      positions += '<div class="more-less">';
      positions += '<a href="#" class="filter-more">+ More</a>';
      positions += '<a href="#" class="filter-less">- Less</a>';
      positions += '</div>';
      positions += '</section>';

      jQuery('#filters').append(positions);

    var countries = '<section>';
    countries += '<h4>Countries</h4>';
    countries += '<ul>';
    var sortedCountries = sortObject(dariahYearbookData.countries);
    var elementId = "";
    for (var sortedCountryId in sortedCountries) {
      var countryId = sortedCountries[sortedCountryId];
      var country = dariahYearbookData.countries[countryId];
      elementId = 'country' + countryId;
      countries += '<li><input id="' + elementId + '" name="countries" type="checkbox" value="' + countryId + '"/><label for="' + elementId + '">' + country + '</label></li>';
    }
    countries += '</ul>';
    countries += '<div class="more-less">';
    countries += '<a href="#" class="filter-more">+ More</a>';
    countries += '<a href="#" class="filter-less">- Less</a>';
    countries += '</div>';
    countries += '</section>';

    jQuery('#filters').append(countries);

    jQuery('#filters input[type="checkbox"]').change(_onFilter);
    updateFilterList();
  };

  var _setResults = function(countries, institutions, positions, searchResults) {
    if (countries || institutions || positions) {
      jQuery('#filters input[type="checkbox"]').parent().addClass('unavailable');
    }
    var peopleWeUse = dariahYearbookData.persons;
    if(searchResults) {
        peopleWeUse = searchResults;
    }
    results = peopleWeUse
      .filter(function(person) {
        if (
          (countries && countries.indexOf(person.country) === -1) ||
          (institutions && institutions.indexOf(person.institution) === -1) ||
          (positions && positions.filter(function(item){
            if(person.positions !== undefined) {return person.positions.indexOf(item) > -1;} return false;
          }).length < 1) )  {
          return false;
        }

        return true;
      })
      .map(function(person) {
        jQuery('#country' + person.country).parent().removeClass('unavailable');
        jQuery('#institution' + person.institution).parent().removeClass('unavailable');
        if(person.positions !== undefined) {
          person.positions.forEach(function(entry) {
              jQuery('#position' + entry).parent().removeClass('unavailable');
          });
        }

        var html = '<li data-person-id="' + person.id + '">';
        html += '<div class="header">';
        html += '<div class="thumb"><img src="' + person.avatar + '" /></div>';
        html += '<p>';
        html += '<span class="name">' + person.firstname + ' ' + person.lastname + '</span>';
        if (person.role) { html += '<span class="role">' + person.role + '</span>'; }
        if (person.positions) {
          html += '<span class="position">';
          for(var i=0; i<person.positions.length; i++) {
              html += dariahYearbookData.positions[person.positions[i]];
              if(i !== person.positions.length - 1) {
                  html += ", ";
              }
          }
          html += '</span>';
        }
        html += '</p>';
        html += '<button class="show-more" data-complete-profile="' + person.id + '">See More</button><button class="show-less">See Less</button>';
        html += '</div>';
        html += '<div class="complete">';
        html += '<ul class="tabs">';
        html += '<li class="about selected"><a href="#" data-tab="about">About</a></li>';
        html += '<li class="position"><a href="#" data-tab="position">Position</a></li>';
        html += '<li class="fields"><a href="#" data-tab="fields">Fields of expertise</a></li>';
        html += '<li class="contact"><a href="#" data-tab="contact">Contact</a></li>';
        html += '</ul>';
        html += '<ul class="content">';
        html += '<li class="about selected">' + person.about + '</li>';
        html += '<li class="position">';
        html += '<ul class="list">';
        if (person.identifiant) { html += '<li>Researcher ID : <span>' + person.identifiant + '</span></li>';}
        if (person.role) { html += '<li>Position : <span>' + person.role + '</span></li>';}
        if (person.institution) { html += '<li>Institution : <span>' + dariahYearbookData.institutions[person.institution].name + '</span></li>';}
        if (person.country) { html += '<li>Country : <span>' + dariahYearbookData.countries[person.country] + '</span></li>';}
        if (person.positions && person.positions.length > 0) {
          html += '<li>Role in DARIAH : <span>';
          for(var j=0; j<person.positions.length; j++) {
            html += dariahYearbookData.positions[person.positions[j]];
            if(j !== person.positions.length - 1) {
              html += ", ";
            }
          }
          html += '</span></li>';
        }
        html += '</ul>';
        html += '</li>';
        html += '<li class="fields">' + person.skills + '</li>';
        html += '<li class="contact">';
        html += '<ul class="list">';
        if (person.email) { html += '<li>Email : <span><a href="mailto:' + person.email + '">' + person.email + '</a></span></li>';}
        if (person.link) { html += '<li>Link : <span><a href="' + person.link + '" target="_blank">' + person.link + '</a></span></li>';}
        if (person.twitter) { html += '<li>Twitter : <span><a href="https://twitter.com/' + person.twitter + '" target="_blank">@' + person.twitter + '</a></span></li>';}
        html += '</ul>';
        html += '</li>';
        html += '</ul></div>';
        html += '</li>';

        return html;
      });

      if (!sortAZ) {
        results = results.reverse();
      }

      totalPages = Math.ceil(results.length / itemPerPage);
      jQuery('#pagination').empty();
      if (totalPages > 1) {
        jQuery('#pagination').append('<ul></ul>');
        jQuery('#pagination ul').append('<li id="previous"><a href="#" data-action="previous">< Previous</a></li>');
        for (var p = 0; p < totalPages; p++) {
          jQuery('#pagination ul').append('<li class="page' + p + '"><a href="#" data-action="' + p + '">' + (p+1) + '</a></li>');
        }
        jQuery('#pagination ul').append('<li id="next"><a href="#" data-action="next">Next ></a></li>');
        jQuery('#pagination').show();
      } else {
        jQuery('#pagination').hide();
      }
      _showResults(0, true);
  };

  var _sortResults = function(event) {
    sortAZ = !sortAZ;
    results = results.reverse();
    _showResults(0, false);
  };

  var _showResults = function(page, scrolltoTop) {
    jQuery('#results').empty();
    var index = page * itemPerPage;
    var text =  (index + 1) + ' - ' + Math.min(index+itemPerPage, results.length) + ' of ' + results.length + ' people';
    var sortText = 'Sort by ' + (sortAZ ? 'Z-A' : 'A-Z');
    var persons = '<div class="head">' + text + '<a href="#" data-sort="true" class="right">' + sortText + '</a></div>';
    persons += '<ul class="results">';

    persons += results.slice(index, index + itemPerPage)
      .join('');
    persons += '</ul>';

    jQuery('#pagination li').removeClass('selected');
    jQuery('#pagination .page' + page).addClass('selected');

    jQuery('#results').append(persons);
    currentPage = page;
    if (currentPage !== 0 && totalPages > 1) {
      jQuery('#previous').show();
    } else {
      jQuery('#previous').hide();
    }

    if (currentPage < totalPages - 1 && totalPages > 1) {
      jQuery('#next').show();
    } else {
      jQuery('#next').hide();
    }
    if (scrolltoTop && window.innerWidth < 768) {
      jQuery("html, body").animate({ scrollTop: 0 }, 500);
    }
  };

  var _onFilter = function(event) {
    jQuery('#filters section').removeClass('all');
    var countries = jQuery('input[name="countries"]:checked').map(function() {
      return parseInt(jQuery(this).val(), 10);
    }).get();
    var institutions = jQuery('input[name="institutions"]:checked').map(function() {
      return parseInt(jQuery(this).val(), 10);
    }).get();
    var positions = jQuery('input[name="positions"]:checked').map(function() {
      return parseInt(jQuery(this).val(), 10);
    }).get();
    currentPage = 0;
    _setResults(
      countries.length > 0 ? countries : null,
      institutions.length > 0 ? institutions : null,
      positions.length > 0 ? positions : null,
      searchInJSON()
    );
    updateFilterList();
  };

  var _onPagination = function(event) {
    event.preventDefault();
    event.stopPropagation();
    var action = event.target.getAttribute('data-action');
    switch(action) {
      case 'previous':
        _showResults(currentPage - 1, true);
        break;
      case 'next':
        _showResults(currentPage + 1, true);
        break;
      default:
        if (action) {
          _showResults(parseInt(action, 10), true);
        }
        break;
    }
  };

  var _onResults = function(event) {
    var tab = event.target.getAttribute('data-tab');
    var completeProfile = event.target.getAttribute('data-complete-profile');
    var sort = event.target.getAttribute('data-sort');

    if (tab) {
      event.preventDefault();
      event.stopPropagation();
      var container = jQuery(event.target).closest('.complete');

      jQuery(container).find('li').removeClass('selected');
      jQuery(container).find('.' + tab).addClass('selected');
    }

    if (completeProfile) {
      jQuery("[data-person-id]").removeClass('show-complete');
      jQuery("[data-person-id=" + completeProfile + "] li").removeClass('selected');
      jQuery("[data-person-id=" + completeProfile + "] .about").addClass('selected');
      jQuery("[data-person-id=" + completeProfile + "]").addClass('show-complete');
    }

    if (sort) {
      event.preventDefault();
      event.stopPropagation();
      _sortResults();
    }

    if (jQuery(event.target).hasClass('show-less')) {
      jQuery("[data-person-id]").removeClass('show-complete');
    }
  };

  function _onFilters(event) {
    if (jQuery(event.target).hasClass('filter-more')) {
      event.preventDefault();
      event.stopPropagation();

      var sectionMore = jQuery(event.target).closest('section');
      jQuery(sectionMore).addClass('all');
      jQuery(sectionMore).find('li:not(".unavailable")').show();
      updateFilterList();
    }

    if (jQuery(event.target).hasClass('filter-less')) {
      event.preventDefault();
      event.stopPropagation();
      var sectionLess = jQuery(event.target).closest('section');
      jQuery(sectionLess).removeClass('all');
      updateFilterList();
    }
  }

  function updateFilterList() {
    jQuery('#filters section').each(function() {
      var showAll = jQuery(this).hasClass('all');
      var notHiding = jQuery(this).find('li').not('.unavailable');

      if (jQuery(notHiding).length <= defaultFilterToShow) {
        jQuery(this).find('.more-less').hide();
      } else {
        jQuery(this).find('.more-less').show();
      }
      jQuery(notHiding).show();
      if (!showAll) {
        jQuery(notHiding).filter(function(index) {
          return index > defaultFilterToShow;
        }).hide();
      }
    });
  }

  function searchInJSON() {
      var results;
      var name = jQuery('#name-search-input').val().toUpperCase();
      results = jQuery.map(dariahYearbookData.persons, function(entry) {
          var match = (entry.firstname.toUpperCase().indexOf(name) !== -1 || entry.lastname.toUpperCase().indexOf(name) !== -1);
          return match ? entry : null;
      });
      return results;
  }

  jQuery(window).ready(function() {
    if (jQuery('#dariahYearbook').length !== 0) {
      jQuery.getJSON(themePath + 'build/yearbook.json', function(data) {
        dariahYearbookData = data;
        _initFilters();
        _setResults();
        jQuery('#pagination').on('click', _onPagination);
        jQuery('#results').on('click', _onResults);
        jQuery('#filters').on('click', _onFilters);

          jQuery('#name-search-input').keyup(function() {
              _onFilter();
          });
      });
    }
  });
})(jQuery);
